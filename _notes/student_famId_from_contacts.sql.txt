WITH SiblingGroups AS
  (SELECT
      StudentsInFamily,
      StudentsInFamilyCount,
      FamilyIdsInFamily, 
      FamilyIdsInFamilyCount,
      FamilyIdsInFamilyDistinctCount,
      StreetAddrsInFamily,
      StreetAddrsInFamilyCnt,
      StreetAddrsFamDistinctCnt,
      MinGradeLvl,
      MaxGradeLvl,
      MinEnrollStat,
      MaxEnrollStat,
      ROWNUM AS RowIndex

    FROM (SELECT DISTINCT *

      FROM (SELECT
          LISTAGG(StudentSibling, ',') WITHIN GROUP (ORDER BY StudentSibling) AS StudentsInFamily,
          COUNT(StudentSibling) AS StudentsInFamilyCount,

          LISTAGG(StudentSibling_FamId, ',') WITHIN GROUP (ORDER BY StudentSibling_FamId) AS FamilyIdsInFamily,
          COUNT(StudentSibling_FamId) AS FamilyIdsInFamilyCount,
          COUNT(DISTINCT StudentSibling_FamId) AS FamilyIdsInFamilyDistinctCount,
          
          LISTAGG(StudentSibling_Street, CHR(59)) WITHIN GROUP (ORDER BY StudentSibling_Street) AS StreetAddrsInFamily,
          COUNT(StudentSibling_Street) AS StreetAddrsInFamilyCnt,
          COUNT(DISTINCT StudentSibling_Street) AS StreetAddrsFamDistinctCnt,

          MIN(SiblingGradeLvl) AS MinGradeLvl,
          MAX(SiblingGradeLvl) AS MaxGradeLvl,
          MIN(SiblingEnrollStat) AS MinEnrollStat,
          MAX(SiblingEnrollStat) AS MaxEnrollStat

        FROM (SELECT DISTINCT
            StudentSelf,
            StudentSibling,
            ss.Grade_Level AS SiblingGradeLvl,
            ss.Enroll_Status AS SiblingEnrollStat,
            ss.Family_Ident AS StudentSibling_FamId,
            ss.Street AS StudentSibling_Street

          FROM (SELECT DISTINCT
              s1.Student_Number AS StudentSelf,
              s1.Student_Number AS Sibling1_SN,
              s2.Student_Number AS Sibling2_SN,
              s3.Student_Number AS Sibling3_SN

            FROM Students s1

            JOIN StudentContactAssoc scaS1P1
              ON s1.Dcid = scaS1P1.StudentDcid

            JOIN OriginalContactMap ocmS1P1
              ON scaS1P1.StudentContactAssocid = ocmS1P1.StudentContactAssocId
                AND LOWER(ocmS1P1.OriginalContactType) IN ('mother', 'father', 'guardian')

            JOIN Person p1
              ON scaS1P1.PersonId = p1.Id

            JOIN StudentContactAssoc scaP1S2
              ON p1.Id = scaP1S2.PersonId

            JOIN OriginalContactMap ocmP1S2
              ON scaP1S2.StudentContactAssocid = ocmP1S2.StudentContactAssocId
              AND LOWER(ocmP1S2.OriginalContactType) IN ('mother', 'father', 'guardian')

            JOIN Students s2
              ON scaP1S2.StudentDcid = s2.Dcid

            JOIN StudentContactAssoc scaS2P2
              ON s2.Dcid = scaS2P2.StudentDcid

            JOIN OriginalContactMap ocmS2P2
              ON scaS2P2.StudentContactAssocid = ocmS2P2.StudentContactAssocId
                AND LOWER(ocmS2P2.OriginalContactType) IN ('mother', 'father', 'guardian')

            JOIN Person p2
              ON scaS2P2.PersonId = p2.Id

            JOIN StudentContactAssoc scaP2S3
              ON p2.Id = scaP2S3.PersonId

            JOIN OriginalContactMap ocmP2S3
              ON scaP2S3.StudentContactAssocid = ocmP2S3.StudentContactAssocId
                AND LOWER(ocmP2S3.OriginalContactType) IN ('mother', 'father', 'guardian')

            JOIN Students s3
              ON scaP2S3.StudentDcid = s3.Dcid )

          UNPIVOT ( StudentSibling FOR (SOURCE_S) IN
            ( Sibling1_SN AS 'S1',
              Sibling2_SN AS 'S2',
              Sibling3_SN AS 'S3'
            )
          )

          JOIN Students ss
            ON StudentSibling = ss.Student_Number

          GROUP BY StudentSelf, StudentSibling,
                   ss.Grade_Level, ss.Enroll_Status,
                   ss.Family_Ident, ss.Street

          ORDER BY StudentSelf, StudentSibling )

        GROUP BY StudentSelf
        ORDER BY StudentSelf )

      ORDER BY StudentsInFamily )
  )

SELECT
  TempFamGrpNumber, 
  StudentsInFamily,
  TempFamGrpMemberCount,
  FamilyIdsInFamily,
  FamilyIdsInFamilyCount, 
  FamilyIdsInFamilyDistinctCount,
  StreetAddrsInFamily,
  StreetAddrsInFamilyCnt,
  StreetAddrsFamDistinctCnt,
  StudentSibling,
  MinGradeLvl,
  MaxGradeLvl,
  MinEnrollStat,
  MaxEnrollStat,
  s.Family_Ident,
  s.Grade_Level,
  s.Enroll_Status,
  scf.Family_Rep
  
FROM (SELECT
  RowIndex AS TempFamGrpNumber,
  StudentsInFamily,
  StudentsInFamilyCount AS TempFamGrpMemberCount,
  FamilyIdsInFamily,
  FamilyIdsInFamilyCount,
  FamilyIdsInFamilyDistinctCount,
  StreetAddrsInFamily,
  StreetAddrsInFamilyCnt,
  StreetAddrsFamDistinctCnt,
  MinGradeLvl,
  MaxGradeLvl,
  MinEnrollStat,
  MaxEnrollStat,
  REGEXP_SUBSTR(StudentsInFamily, chr(91)||'^,'||chr(93)||'+', 1, column_value) StudentSibling
  FROM SiblingGroups,
       TABLE(CAST(MULTISET(SELECT level FROM Dual
                           CONNECT BY level <= REGEXP_COUNT (StudentsInFamily, ',') + 1
                           ) as sys.odcinumberlist))
)

JOIN Students s 
  ON StudentSibling = s.Student_Number

 JOIN StudentCoreFields scf
   ON s.Dcid = scf.StudentsDcid

ORDER BY s.Family_Ident NULLS FIRST, 
         StudentSibling, TempFamGrpNumber


